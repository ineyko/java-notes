# 日志性能问题踩坑

问题描述：

生产环境在运行一段时间后，发现某一个服务的性能，下降得很厉害，并且CPU使用率非常高。

问题定位：

最终在代码中发现在一个自定义的 print 方法中存在大量的循环字符串拼接，而这个 print 方法又在外部被许多地方调用。代码如下：
```java
public void print(){
  StringBuilder sb = new StringBuilder();
  globalMap.foreach(t -> {
    sb.append("日志内容xxxx");
    sb.append("日志内容xxx");
  })
  log.trace(sb.toString());
}
```

问题解决：

将 print 方法注释掉之后，实测 TPS 上升2倍多。
由此引发了我对日志打印性能的一些思考。

---

日志是一个系统中程序员定位问题的常用手段，但日志好用不代表日志可以滥用，要明白日志的级别，在什么地方应该输出什么级别的日志，要结合实际的情况作出合理的选择。

在 Log4j 日志框架中，不支持 {} 字符串的模版写法，所以建议在输出前加入 is 判断：
```java
if(logger.isDebuged()) {
  log.debug("this is simple log.");
}
```
如果不加判断所带来的坏处是，不管日志级别如何，都会将日志输出的这行字符串加载一次，极大的浪费空间。

在 logback 与 log4j2 中支持了模版写法，则不需要加入这样的判断。所以在日志打印时，尽量使用 {} 模版写法，不要使用字符串拼接的方式去打印日志。

另外，在日常开发中，应该多注意日志细节，大量需要打印日志的地方尽量避免使用循环打印，因为日志的本质是IO输出到文件或者控制台，循环打印会影响系统性能。